<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loopify Referral System - Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #000000 0%, #000000 100%);
      color: #f5f5f5;
    }
  </style>
</head>
<body>
  <div class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-4xl font-bold text-green-400 mb-2">ðŸŒ± Loopify Referral System</h1>
        <p class="text-gray-400">Comprehensive referral reward implementation for sustainability platform</p>
      </div>

      <!-- Main Container -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        
        <!-- Panel 1: User Management -->
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
          <h2 class="text-xl font-bold text-green-400 mb-4">
            <i class="fas fa-user-circle"></i> User Management
          </h2>
          
          <div class="space-y-3 mb-4">
            <input 
              id="userId" 
              type="text" 
              placeholder="Enter User ID" 
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white"
              value="user-demo-1"
            />
            <label class="flex items-center gap-2 cursor-pointer">
              <input 
                id="isNewUser" 
                type="checkbox" 
                checked 
                class="w-4 h-4 rounded"
              />
              <span>Is New User</span>
            </label>
          </div>

          <button 
            onclick="initializeUserDemo()"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mb-3"
          >
            <i class="fas fa-play"></i> Initialize User
          </button>

          <button 
            onclick="completeFirstActionDemo()"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-3"
          >
            <i class="fas fa-check"></i> Complete First Action
          </button>

          <button 
            onclick="displayReferralCodeDemo()"
            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded"
          >
            <i class="fas fa-qrcode"></i> Show Referral Code
          </button>
        </div>

        <!-- Panel 2: Referral Code Entry -->
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
          <h2 class="text-xl font-bold text-green-400 mb-4">
            <i class="fas fa-ticket-alt"></i> Enter Referral Code
          </h2>
          
          <div class="space-y-3 mb-4">
            <input 
              id="referralCode" 
              type="text" 
              placeholder="e.g., LOOP-7A3F" 
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white font-mono text-lg text-center"
            />
            <p class="text-sm text-gray-400 text-center">
              First, initialize a user. Then use their referral code here.
            </p>
          </div>

          <button 
            onclick="showReferralModalDemo()"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded mb-3"
          >
            <i class="fas fa-modal"></i> Show Referral Modal
          </button>

          <button 
            onclick="testReferralFlowDemo()"
            class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded"
          >
            <i class="fas fa-flask"></i> Test Full Flow
          </button>
        </div>
      </div>

      <!-- Status Panel -->
      <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-bold text-green-400 mb-4">
          <i class="fas fa-info-circle"></i> System Status
        </h2>
        
        <div id="status-panel" class="space-y-2 font-mono text-sm text-gray-400">
          <div>Status: <span class="text-yellow-400">Initializing...</span></div>
          <div>Users: <span class="text-blue-400">0</span></div>
          <div>Referrals: <span class="text-green-400">0</span></div>
          <div>Total Points Distributed: <span class="text-purple-400">0</span></div>
        </div>
      </div>

      <!-- Referral Code Display Area -->
      <div id="referral-widget-container" class="mb-8"></div>

      <!-- Dashboard Area -->
      <div id="referral-dashboard-container" class="mb-8"></div>

      <!-- Debug Console -->
      <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
        <h2 class="text-xl font-bold text-green-400 mb-4">
          <i class="fas fa-terminal"></i> Debug Console
        </h2>
        
        <div id="debug-console" class="bg-black rounded p-3 font-mono text-xs text-green-400 h-48 overflow-y-auto">
          <div>[System Ready]</div>
        </div>

        <button 
          onclick="clearDebugConsole()"
          class="mt-3 bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm"
        >
          Clear Console
        </button>
      </div>
    </div>
  </div>

  <!-- Include Referral System Scripts -->
  <script src="referral-system.js"></script>
  <script src="referral-ui.js"></script>
  <script src="referral-integration.js"></script>

  <script>
    // Demo Functions
    let currentUserId = null;

    function log(message) {
      const console = document.getElementById('debug-console');
      const time = new Date().toLocaleTimeString();
      const line = document.createElement('div');
      line.textContent = `[${time}] ${message}`;
      console.appendChild(line);
      console.scrollTop = console.scrollHeight;
    }

    function clearDebugConsole() {
      document.getElementById('debug-console').innerHTML = '[Console Cleared]';
    }

    function updateStatus() {
      const users = referralSystem.getAllUsers();
      const totalReferrals = users.filter(u => u.referredBy !== null).length;
      const completedReferrals = users.filter(u => u.referralRewardGiven).length;
      const totalPoints = completedReferrals * referralSystem.REFERRED_USER_REWARD;

      document.getElementById('status-panel').innerHTML = `
        <div>Status: <span class="text-green-400">Running</span></div>
        <div>Total Users: <span class="text-blue-400">${users.length}</span></div>
        <div>Users With Referrals: <span class="text-green-400">${totalReferrals}</span></div>
        <div>Completed Referrals: <span class="text-purple-400">${completedReferrals}</span></div>
        <div>Total Points Distributed: <span class="text-yellow-400">+${totalPoints}</span></div>
      `;
    }

    function initializeUserDemo() {
      const userId = document.getElementById('userId').value || 'user-' + Date.now();
      const isNewUser = document.getElementById('isNewUser').checked;

      currentUserId = userId;
      
      try {
        referralIntegration.initializeApp(userId, isNewUser);
        
        const user = referralSystem.getUserById(userId);
        log(`âœ… User initialized: ${userId}`);
        log(`   Referral Code: ${user.referralCode}`);
        
        // Update referral code input
        document.getElementById('referralCode').value = user.referralCode;
        
        updateStatus();
      } catch (error) {
        log(`âŒ Error: ${error.message}`);
      }
    }

    function completeFirstActionDemo() {
      if (!currentUserId) {
        log('âŒ Please initialize a user first');
        return;
      }

      try {
        const result = referralIntegration.processFirstAction('return', 10);
        
        log(`âœ… First action processed for ${currentUserId}`);
        if (result.referralRewardApplied) {
          log(`   ðŸŽ‰ Referral bonus awarded: +${result.bonusPoints} points`);
          log(`   Referrer: ${result.referredByUserId} (+${result.referrerReward} points)`);
        } else {
          log(`   No referral bonus (not referred)`);
        }
        
        updateStatus();
      } catch (error) {
        log(`âŒ Error: ${error.message}`);
      }
    }

    function displayReferralCodeDemo() {
      if (!currentUserId) {
        log('âŒ Please initialize a user first');
        return;
      }

      try {
        referralIntegration.displayUserReferralCode('referral-widget-container');
        log(`âœ… Referral code widget displayed`);
      } catch (error) {
        log(`âŒ Error: ${error.message}`);
      }
    }

    function showReferralModalDemo() {
      const userId = document.getElementById('userId').value || 'user-' + Date.now();
      
      try {
        referralUI.showReferralEntryModal(userId, (code) => {
          log(`âœ… Referral modal closed, code entered: ${code || 'skipped'}`);
          if (code) {
            document.getElementById('referralCode').value = code;
          }
        });
        log(`âœ… Referral entry modal shown`);
      } catch (error) {
        log(`âŒ Error: ${error.message}`);
      }
    }

    function testReferralFlowDemo() {
      try {
        log('ðŸ§ª Starting full referral flow test...');

        // Step 1: Create referrer
        const referrer = referralSystem.getOrCreateUser('referrer-test-' + Date.now());
        log(`1. Referrer created: ${referrer.referralCode}`);

        // Step 2: Create new user with referral
        const newUser = referralSystem.getOrCreateUser(
          'referred-test-' + Date.now(), 
          referrer.referralCode
        );
        log(`2. New user created and referred: ${newUser.referralCode}`);

        // Step 3: Process first action
        const result = referralSystem.processFirstActionReward(newUser.userId, 'return', 10);
        log(`3. First action processed`);
        log(`   Referred user reward: +${result.bonusPoints} points`);
        log(`   Referrer reward: +${result.referrerReward} points`);

        // Step 4: Show stats
        const referrerStats = referralSystem.getReferralStats(referrer.userId);
        log(`4. Referrer stats:`);
        log(`   Total invites: ${referrerStats.totalReferrals}`);
        log(`   Completed: ${referrerStats.totalRewarded}`);
        log(`   Points earned: ${referrerStats.totalPointsEarned}`);

        log('âœ… Test completed successfully!');
        updateStatus();
      } catch (error) {
        log(`âŒ Test failed: ${error.message}`);
      }
    }

    // Initialize on load
    window.addEventListener('load', () => {
      log('âœ… Referral System loaded');
      log('   - referral-system.js active');
      log('   - referral-ui.js active');
      log('   - referral-integration.js active');
      updateStatus();
    });
  </script>
</body>
</html>
